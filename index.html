<html>
    <head>
        <title>Snake World - Win your internship.</title>
    </head>
    <body>
        
        <div style="float:right; width: 300px; display: block; top: 0px; right: 0px;">
            <h1>Snake World </h1>
            <button id="play">Jouer !</button><br />
            <h2>Leader board</h2>
                <div id="scoreboard"></div>
            <h2>More information</h2>
            <div id="more">
                You can contribute with pull request on Github here.
            </div>
        </div>
        <!-- Lets make a simple snake game -->
        <canvas id="canvas" width="450" height="450"></canvas>
        
        <!-- Jquery -->
        <script src="//code.jquery.com/jquery-1.11.3.min.js"></script>
        
        <script>
            $(document).ready(function(){
            	//Canvas stuff
            	var canvas = $("#canvas")[0];
            	var ctx = canvas.getContext("2d");
            	var square_size = 5; // Size of a square in px
            	
            	var login = null;
            	var socket = new WebSocket('wss://snakeworld-trecouvr.c9.io/');
            	socket.onopen = function (event) {
            	    console.log("Socket open");
            	    $("#play").show();
            	};
            	
            	$("#play").click(function() { startGame(); });
            	
            	// Retry connection if server restart
            	socket.onclose = function(event) {
            	    socket = new WebSocket('wss://snakeworld-trecouvr.c9.io/');
            	}
            	socket.onerror = function(event) {
            	    socket = new WebSocket('wss://snakeworld-trecouvr.c9.io/');
            	}
            	
            	socket.onmessage = function(event) {
            	   if(event.data == "Success") {
            	       // Cool
            	   } else {
            	    draw(JSON.parse(event.data));
            	   }
            	};
            	
            	function draw(map) {
            	    var w = map.size.width * square_size;
            	    var h = map.size.height * square_size;
            	    
            	    // Adapt canvas to map size
            	    $("#canvas").width(w);
            	    $("#canvas").height(h);
            	    $("#canvas").attr('width', w);
            	    $("#canvas").attr('height', h);
            	    
            	    
            	    // flush canvas
            	    ctx.fillStyle = "black";
            		ctx.fillRect(0, 0, w, h);
            		ctx.strokeStyle = "white";
            		ctx.strokeRect(0, 0, w, h);
            		
            		// draw snakes
            		for(var i in map.snakes) {
            		    drawSnake(map.snakes[i]);
            		}
            		
            		// draw fruits
            		for(var i in map.fruits) {
            		    paintCell(map.fruits[i], "#00FF00");
            		}
            		
            		// draw walls
            		
            		
            		// draw scoreboard
            		var table = '<table><thead><th>Snake</th><th>Size</th><th>Max size</th></thead>';
            		table += '<tbody>';
            		for(var i in map.snakes) {
            		   var snake = map.snakes[i];
            		   table += '<tr><td><span style="color: ' + snake.color + ';">'+snake.name+'</td><td>' + snake.length + '</td><td>' + snake.best_length + '</td></tr>';
            		}
            		table += '</tbody></table>';
            		$('#scoreboard').html(table);
            	}
            	
            	function drawSnake(snake) {
            	    for(var i in snake.body) {
            	        paintCell(snake.body[i], snake.color);
            	    }
            	}
            	
            	//Lets first create a generic function to paint cells
            	function paintCell(cell, color)
            	{
            		ctx.fillStyle = color;
            		ctx.fillRect(cell.x*square_size, cell.y*square_size, square_size, square_size);
            		ctx.strokeStyle = "black";
            		ctx.strokeRect(cell.x*square_size, cell.y*square_size, square_size, square_size);
            	}
            	
            	function startGame() {
            	    // Function to start a human game
            	    if(login===null) {
            	        login = prompt("Please enter your login");
            	    }
            	    if(login===null || login==="") {
            	        login=null;
            	        return;
            	    }
            	    socket.send('{"name": "'+login+'"}');
            	    $("#play").hide();
            	}

            	//Lets add the keyboard controls now
            	$(document).keydown(function(e){
            		var key = e.which;
            		var d="";
            		//We will add another clause to prevent reverse gear
            		if(key == "37" && d != "right") d = "l";
            		else if(key == "38" && d != "down") d = "u";
            		else if(key == "39" && d != "left") d = "r";
            		else if(key == "40" && d != "up") d = "d";
            		
            		if(d!="") {
            		    socket.send(JSON.stringify({"direction": d}));
            		}
            	});
            })
        </script>
    </body>
</html>

